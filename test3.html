<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Konum Edit√∂r√º Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* --- Genel Stiller --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* --- √úst Panel (Header) --- */
        .header { background: rgba(255, 255, 255, 0.95); padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #666; font-size: 14px; margin-bottom: 20px; }
        .format-info { background: #f0f7ff; border-left: 4px solid #667eea; padding: 12px; margin-bottom: 20px; border-radius: 4px; }
        .format-info strong { color: #667eea; }

        /* --- Kontrol Butonlarƒ± --- */
        .controls { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-wrapper label {
            padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
            border-radius: 8px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; font-weight: 500;
        }
        .file-input-wrapper label:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; font-size: 14px; }
        .btn-export { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-export:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4); }
        .btn-clear { background: #ff6b6b; color: white; }
        .btn-clear:hover { background: #ff5252; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .stats { background: white; padding: 10px 20px; border-radius: 8px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stats-icon { width: 24px; height: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }

        /* --- Harita ve Y√ºkleme Animasyonu --- */
        .map-container { flex: 1; margin: 20px; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); background: white; position: relative; }
        #map { height: 600px; width: 100%; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px 40px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000; display: none; }
        .loading.active { display: block; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Bildirim --- */
        .notification { position: fixed; bottom: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; animation: slideIn 0.3s ease; z-index: 2000; }
        .notification.active { display: block; }
        .notification.error { background: #f44336; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- Geli≈ümi≈ü Popup Stilleri --- */
        .custom-popup { min-width: 280px; max-width: 400px; padding: 0; }
        .popup-title {
            font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #333;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .popup-coords { color: #666; font-size: 12px; margin-bottom: 12px; }
        .popup-photos { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .popup-photo { width: 80px; height: 80px; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .popup-photo:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .popup-photo img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .popup-photo.loading { background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999; }
        .popup-button {
            display: block; background: #f0f0f0; color: #333; padding: 8px 14px; border-radius: 5px;
            text-decoration: none; font-size: 13px; text-align: center; border: 1px solid #ccc;
            transition: all 0.3s; width: 100%;
        }
        .popup-button:hover {
            transform: translateY(-1px); box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: transparent;
        }

        /* --- Fotoƒüraf G√∂r√ºnt√ºleyici (Modal) Stilleri --- */
        .photo-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px);
            z-index: 3000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease-out;
        }
        .photo-modal.show { opacity: 1; }
        .modal-content { position: relative; max-width: 90vw; max-height: 90vh; transform: scale(0.8); transition: transform 0.3s ease-out; }
        .photo-modal.show .modal-content { transform: scale(1); }
        .modal-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        .modal-close {
            position: absolute; top: -50px; right: -10px; background: rgba(255, 255, 255, 0.9);
            color: #333; border: none; border-radius: 50%; width: 40px; height: 40px;
            font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .modal-close:hover { background: white; transform: scale(1.1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .modal-info {
            position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); color: #333;
            padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üó∫Ô∏è Google Maps Konum Edit√∂r√º Pro</h1>
            <p class="subtitle">CSV dosyasƒ±ndan konumlarƒ±, linkleri ve fotoƒüraflarƒ± y√ºkleyip harita olu≈üturun</p>
            
            <div class="format-info">
                <strong>üìã CSV Formatƒ±:</strong> 
                A: Konum Adƒ± | B: Google Maps Linki | C, D, E: Fotoƒüraf URL'leri
                <br>
                <small>üí° ƒ∞pucu: Kƒ±rmƒ±zƒ± noktalara tƒ±klayarak konum detaylarƒ±nƒ± ve fotoƒüraflarƒ± g√∂r√ºnt√ºleyin.</small>
            </div>
            
            <div class="controls">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" accept=".csv">
                    <label for="csvFile">üìÅ CSV Dosyasƒ± Se√ß</label>
                </div>
                <button class="btn btn-export" id="exportBtn" disabled>üì§ HTML Olarak Dƒ±≈üa Aktar</button>
                <button class="btn btn-clear" id="clearBtn" disabled>üóëÔ∏è Haritayƒ± Temizle</button>
                <div class="stats">
                    <div class="stats-icon">üìç</div>
                    <span id="locationCount">0 konum y√ºklendi</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Konumlar i≈üleniyor...</p>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <div class="photo-modal" id="photoModal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" id="modalCloseBtn" title="Kapat (ESC)">‚úï</button>
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <script>
        const map = L.map('map').setView([39.92, 32.85], 6); // T√ºrkiye merkez
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];
        let locations = [];
        let photosLoaded = {};

        // --- Ana Fonksiyonlar ---
        function extractCoordinates(url) {
            if (!url) return null;
            const patterns = [
                /@(-?\d+\.\d+),(-?\d+\.\d+)/, /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/,
                /place\/[^\/]+\/@(-?\d+\.\d+),(-?\d+\.\d+)/, /ll=(-?\d+\.\d+),(-?\d+\.\d+)/,
                /q=(-?\d+\.\d+),(-?\d+\.\d+)/, /dir\/[^\/]+\/(-?\d+\.\d+),(-?\d+\.\d+)/,
                /data=[^@]*@(-?\d+\.\d+),(-?\d+\.\d+)/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    const lat = parseFloat(match[1]);
                    const lng = parseFloat(match[2] || match[1].split(',')[1]);
                    if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                        return { lat, lng };
                    }
                }
            }
            return null;
        }

        function openPhotoModal(imageUrl, locationName) {
            const modal = document.getElementById('photoModal');
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('modalInfo').textContent = locationName;
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function loadPhotosForLocation(locationIndex) {
            if (photosLoaded[locationIndex]) return;
            const location = locations[locationIndex];
            const photoElements = document.querySelectorAll(`.photo-${locationIndex}`);
            photoElements.forEach((element, index) => {
                if (location.photos[index]) {
                    const img = new Image();
                    img.onload = () => {
                        element.innerHTML = `<img src="${location.photos[index]}" alt="${location.name} - Fotoƒüraf ${index + 1}">`;
                        element.classList.remove('loading');
                    };
                    img.onerror = () => {
                        element.innerHTML = '‚ùå'; element.classList.remove('loading');
                    };
                    img.src = location.photos[index];
                }
            });
            photosLoaded[locationIndex] = true;
        }

        function clearMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = []; locations = []; photosLoaded = {};
            updateStats();
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('clearBtn').disabled = true;
            document.getElementById('csvFile').value = '';
        }

        function updateStats() {
            document.getElementById('locationCount').textContent = `${locations.length} konum y√ºklendi`;
        }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification active' + (isError ? ' error' : '');
            setTimeout(() => notification.classList.remove('active'), 3000);
        }
        
        // --- Olay Dinleyicileri (Event Listeners) ---
        document.getElementById('photoModal').addEventListener('click', closePhotoModal);
        document.getElementById('modalCloseBtn').addEventListener('click', closePhotoModal);
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closePhotoModal();
        });
        document.getElementById('clearBtn').addEventListener('click', clearMap);

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('loading').classList.add('active');
            clearMap();

            Papa.parse(file, {
                complete: function(results) {
                    let validLocations = 0, invalidLocations = 0;
                    results.data.forEach((row, index) => {
                        if ((index === 0 && row[0] && (row[0].toLowerCase().includes('konum') || row[0].toLowerCase().includes('name'))) || row.length < 2) {
                            return; 
                        }
                        const name = (row[0] || `Konum #${validLocations + 1}`).trim();
                        const url = (row[1] || '').trim();
                        const photos = [row[2], row[3], row[4]].filter(p => p && p.trim()).map(p => p.trim());
                        
                        const coords = extractCoordinates(url);
                        if (coords) {
                            const locationIndex = locations.length;
                            locations.push({ lat: coords.lat, lng: coords.lng, name: name, url: url, photos: photos });
                            
                            const marker = L.circleMarker([coords.lat, coords.lng], {
                                radius: 8, fillColor: '#ff4444', color: '#ffffff', weight: 2,
                                opacity: 1, fillOpacity: 0.8, className: 'marker-custom'
                            }).addTo(map);

                            const createPopupContent = () => {
                                let photosHtml = '';
                                if (photos.length > 0) {
                                    photosHtml = '<div class="popup-photos">';
                                    photos.forEach((photo, i) => {
                                        photosHtml += `<div class="popup-photo loading photo-${locationIndex}" onclick="if(!this.classList.contains('loading')) openPhotoModal('${photo}', '${name.replace(/'/g, "\\'")}')">‚è≥</div>`;
                                    });
                                    photosHtml += '</div>';
                                }
                                return `<div class="custom-popup">
                                    <div class="popup-title">${name}</div>
                                    <div class="popup-coords">Lat: ${coords.lat.toFixed(6)}<br>Lng: ${coords.lng.toFixed(6)}</div>
                                    ${photosHtml}
                                    <a href="${url}" target="_blank" class="popup-button">üó∫ Google Maps'te A√ß</a>
                                </div>`;
                            };
                            
                            marker.bindPopup(createPopupContent());
                            marker.on('popupopen', () => loadPhotosForLocation(locationIndex));
                            markers.push(marker);
                            validLocations++;
                        } else if(url) {
                            invalidLocations++;
                        }
                    });

                    document.getElementById('loading').classList.remove('active');
                    if (validLocations > 0) {
                        const group = L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                        document.getElementById('exportBtn').disabled = false;
                        document.getElementById('clearBtn').disabled = false;
                        let message = `‚úÖ ${validLocations} konum ba≈üarƒ±yla y√ºklendi.`;
                        if (invalidLocations > 0) message += ` (${invalidLocations} ge√ßersiz satƒ±r atlandƒ±)`;
                        showNotification(message);
                    } else {
                        showNotification('‚ùå Ge√ßerli konum bulunamadƒ±. CSV formatƒ±nƒ± kontrol edin.', true);
                    }
                    updateStats();
                },
                error: function(error) {
                    document.getElementById('loading').classList.remove('active');
                    showNotification('‚ùå Dosya okuma hatasƒ±: ' + error.message, true);
                }
            });
        });

        document.getElementById('exportBtn').addEventListener('click', function() {
            if (locations.length === 0) {
                showNotification('‚ùå Dƒ±≈üa aktarƒ±lacak konum yok.', true);
                return;
            }
            const htmlContent = `<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konum Haritasƒ± - ${locations.length} Nokta</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .custom-popup { min-width: 280px; max-width: 400px; }
        .popup-title { font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #10b981; }
        .popup-coords { color: #666; font-size: 12px; margin-bottom: 12px; }
        .popup-photos { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .popup-photo { width: 80px; height: 80px; border-radius: 8px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .popup-photo img { width: 100%; height: 100%; object-fit: cover; }
        .popup-button { display: block; background: #667eea; color: white; padding: 8px 14px; border-radius: 5px; text-decoration: none; font-size: 13px; text-align: center; border: none; }
        .photo-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-content { position: relative; max-width: 90vw; max-height: 90vh; }
        .modal-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 12px; }
        .modal-close { position: absolute; top: -40px; right: 0; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; }
    <\/style>
</head>
<body>
    <div id="map"><\/div>
    <div class="photo-modal" id="photoModal">
        <div class="modal-content"><button class="modal-close" id="modalCloseBtn">‚úï</button><img class="modal-image" id="modalImage" src=""></div>
    </div>
    <script>
        const map = L.map('map').setView([39.92, 32.85], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const locations = ${JSON.stringify(locations)};
        const markers = [];
        
        function openPhotoModal(url) {
            document.getElementById('modalImage').src = url;
            document.getElementById('photoModal').style.display = 'flex';
        }
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }
        document.getElementById('photoModal').addEventListener('click', closePhotoModal);
        document.getElementById('modalCloseBtn').addEventListener('click', closePhotoModal);
        document.addEventListener('keydown', (e) => e.key === 'Escape' && closePhotoModal());

        locations.forEach(loc => {
            let photosHtml = '';
            if (loc.photos && loc.photos.length > 0) {
                photosHtml = '<div class="popup-photos">';
                loc.photos.forEach(photo => {
                    photosHtml += \`<div class="popup-photo" onclick="openPhotoModal('\${photo}')"><img src="\${photo}" alt="\${loc.name}"></div>\`;
                });
                photosHtml += '</div>';
            }
            const popupContent = \`<div class="custom-popup"><div class="popup-title">\${loc.name}</div><div class="popup-coords">Lat: \${loc.lat.toFixed(6)}<br>Lng: \${loc.lng.toFixed(6)}</div>\${photosHtml}<a href="\${loc.url}" target="_blank" class="popup-button">Google Maps'te A√ß</a></div>\`;
            const marker = L.circleMarker([loc.lat, loc.lng], { radius: 8, fillColor: '#ff4444', color: '#fff', weight: 2, fillOpacity: 0.8 }).bindPopup(popupContent).addTo(map);
            markers.push(marker);
        });
        if (markers.length > 0) {
            map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
        }
    <\/script>
</body>
</html>`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'konum_haritasi.html';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('‚úÖ Harita ba≈üarƒ±yla dƒ±≈üa aktarƒ±ldƒ±!');
        });
    </script>
</body>
</html>
